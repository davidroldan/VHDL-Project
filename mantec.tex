\documentclass{article}

\usepackage[utf8x]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{palatino}
\usepackage[english, spanish, es-noquoting]{babel}
\usepackage{babelbib}
\usepackage{anysize}
\usepackage{tabu}
\usepackage{graphicx}
\usepackage{tikz}
\usepackage{url}
\usepackage[colorlinks]{hyperref}

% Configuración TikZ
\usetikzlibrary{positioning, calc}
\tikzset{modulo/.style={fill=yellow!80!black}, lineamus/.style={draw=green!80!black, thick}}

% Metadatos del PDF
\hypersetup{
	pdftitle={Teclado: manual técnico},
	pdfsubject={Tecnología y Organización de Computadores}
}

% Ajuste de rotura de palabras en salto de línea
\hyphenpenalty=5000
\tolerance=1000

\title{Teclado: manual técnico}
\author{Juan Andrés Claramunt Pérez, David Roldán Santos y Rubén Rafael Rubio Cuéllar}

\begin{document}

\maketitle

\tableofcontents

\section{Descripción del diseño}

\subsection{Ruta de datos}

\begin{figure}[ht]\centering
	\begin{tikzpicture}[node distance=5mm and 5mm]
		% Módulos de diseño del proyecto
		\node (UC) [modulo] {unidad central};
		\node (Gen) [above left= -1mm and 1cm of UC.north west, modulo] {gensonido};
		\node (Codec) [below left= 1mm and 1cm of UC.south west, modulo] {códec de audio};
		\node (Vga) [below=1 cm of UC, modulo] {vga};
		\node (VgaBarra) [below left=of Vga, modulo] {vga\_barra};
		\node (VgaTeclado) [below right=of Vga, modulo] {vga\_teclado};
		\node (Recon) [above=1cm of UC, modulo] {reconocedor}; 
		\node (Arch) [right=1.5 cm of UC, modulo] {archivero};
		\node (Mem) [above =of Arch, modulo] {(memoria)};
		\node (UART) [below=of Arch, modulo] {UART};
		\node (Grab) [above right= 0mm and 4mm of Arch.north east, modulo] {grabador};
		\node (Repr) [below right= 0mm and 4mm of Arch.south east, modulo] {reproductor};

		% Conexiones entre los módulos
		\draw [<-] (UC.180) -- (Gen);
		\draw [->, lineamus] (UC.north west) -- (Gen.5);
		\draw [<->, lineamus] (UC) -- (Arch);
		\draw (Arch) -- (Grab);
		\draw (Arch) -- (Repr);
		\draw (Arch) -- (Mem);
		\draw (Arch) -- (UART);
		\draw [->, lineamus] (UC) -- (Vga);
		\draw (Vga) -- (VgaBarra);
		\draw (Vga) -- (VgaTeclado);
		\draw [<->] (UC.south west) -- (Codec.0);
		\draw [->, lineamus]  (Recon.-40) -- (UC.40);
		\draw [->] (Recon.-140)-- (UC.140);
	\end{tikzpicture}
	\caption{Esquema de módulos e interconexión}
	\label{fig:esquema}
\end{figure}

	En la figura \ref{fig:esquema} las líneas gruesas verdes indican el paso de los ``parámetros musicales'': nota (3 bits), octava (3 bits) y sostenido (3 bits). Esta terna es el dato principal del diseño. Se origina en el {\itshape reconocedor} como resultado de la interacción del usuario o en el {\itshape archivero} por la reproducción de un archivo grabado. La unidad central selecciona la fuente activa en cada momento. Su destino es el  generador de sonidos ({\itshape gensonido}) que produce una onda cuadrada; también llega al controlador de pantalla y al archivero para la grabación.

\begin{figure}[ht]\centering
	\begin{tikzpicture}
		% Módulos interconectados
		\node (UC) [modulo, minimum width=10cm] {unidad central\strut};
		\node (Gen) [above=1cm of UC, modulo, minimum width=6cm] {gensonido\strut};
		\node (Tab) [above left=2em and -8em of Gen, modulo] {tablanotas};
		\node (TabS) [above right=2em and -8em of Gen, modulo] {tablanotassos};

		% Conexiones
		\draw [->] (UC.172) -- node[left]{\small reloj/reset} (Gen.-172); % reloj/reset
		\draw [->, lineamus] (UC.150) -- (Gen.-150);
		\draw [->] (Gen.-30) -- node[right]{\small onda} (UC.30);

		% Conexiones con las ROM
		\draw [->] (Gen.168) -- node[left]{\small nota} (Tab.-150);
		\draw [<-] (Gen.153) -- (Tab.-29);
		\draw [->] (Gen.30) -- (TabS.-162);
		\draw [<-] (Gen.9) -- node[right]{\small semiperiodo} (TabS.-19);
	\end{tikzpicture}

	\caption{Conexiones del generador de sonidos}
	\label{fig:gensonido}
\end{figure}

	\medskip La señal sonora generada por {\itshape gensonido} se dirige a un pin de salida de la FPGA para ser conectada a un zumbador o semejante. Sin embargo se conecta también al códec de audio que produce una señal analógica por el puerto de salida jack de 3,5mm del dispositivo.

	\medskip La memoria se gestiona en el módulo {\itshape archivero}. Se organiza en 20 bloques RAM de doble puerto y anchura 16 bits compartidos por el grabador, el reproductor y el transmisor. El reproductor lee desde el puerto A, el grabador escribe en el puerto B y el transmisor realiza sendas operaciones en los puertos cruzados. La reproducción y la grabación no pueden darse simultáneamente\footnote{Técnicamente sería posible en memorias diferentes con ligeras modificaciones.}, sin embargo la carga o descarga de datos por el transmisor pueden acontecer concurrentemente con aquellas si involucran a bloques distintos. El control de la compartición se maneja en el módulo.

\subsection{Controladores}

\begin{enumerate}
	\item {\itshape Controlador de teclado}: maneja la entrada por teclado. Las pulsaciones permiten tocar las notas musicales y activar ciertos comandos comandos de la máquina. El controlador recibe datos a través de la línea \verb|PS2DATA| con reloj \verb|PS2CLK| en serie desde el teclado. En base a ello establece valores acordes para los parámetros musicales o activa señales que desencadenarán acciones en otros componentes externos.

\begin{figure}[ht]\centering
	\begin{tikzpicture}
		% Módulos interconectados
		\node (UC) [modulo, minimum width=10cm] {unidad central};
		\node (Recon) [above=1cm of UC, modulo, minimum width=6cm] {reconocedor}; 

		% Conexiones
		\draw [->] (UC.174) -- node[left]{\small reloj/reset} (Recon.-174); % reloj/reset
		\draw [->, lineamus] (Recon.-170) -- (UC.170);
		\draw [->] (Recon.-7) -- (UC.7);		% botón octava+
		\draw [->] (Recon.-8) -- (UC.8);		% botón octava-
		\draw [->] (Recon.-10) -- (UC.10);	% botón parada
		\draw [->] (Recon.-12) -- (UC.12);	% botón reproducción
		\draw [->] (Recon.-15) -- node[left]{\small activadores} (UC.15); % botón grabación

		\draw [->, thick] (Recon.-6) -- node[right] {\small octava base} (UC.6);
	\end{tikzpicture}

	\caption{Conexiones del reconocedor}
	\label{fig:reconocedor}
\end{figure}

	\item {\itshape Controlador de pantalla}: se encarga de la salida por pantalla. El controlador lee las distintas señales que contienen la información sobre lo que se desea visualizar. A través de dos contadores que recorren la pantalla (\verb|hsync| y \verb|vsync|), se enviará la información al puerto VGA píxel a píxel.

	\item {\itshape Grabador/reproductor}: registra o reproduce una sucesión de notas musicales con su duración, siguiendo el formato FLAN ({\itshape Formato Lineal de Audible Notación}) que se compone de cuadros de 16 bits que representan notas musicales o comandos especiales (si el campo \verb|esp| está a 0). El campo nota toma valores \verb|000| para silencio, \verb|001| para la nota do y así sucesivamente hasta \verb|111| para la nota si. El campo \verb|octava| indica la octava numerada del 0 al 7 y \verb|sos| activa a 1 el sostenido. Se reservan 8 bits para la duración. El único comando especial reconocido es la marca de fin, totalmente nula. 

	\begin{figure}[ht] \centering
		\begin{tabular}{| l | l | l | l | l | l | l | l | l | l | l | l | l | l | l | l |}
			\hline esp & \multicolumn{3}{c|}{nota} & \multicolumn{3}{c|}{octava} & sos & \multicolumn{8}{c|}{duración} \\ \hline
			& & & & & & & & & & & & & & & \\ \hline
		\end{tabular}

		\label{fig:flan}
		\caption{Esquema del formato de representación FLAN}
	\end{figure}

	Tanto el grabador como el reproductor utilizan señales de reloj dividido a $2^{21}$ veces el reloj de la FPGA.

	\item {\itshape Controlador de comunicación serie}: maneja la comunicación bidireccional con el ordenador mediante el puerto serie RS232. El protocolo de comunicación permite enviar y recibir archivos de audio para ser cargados en la memoria.

	Las dos modalidades comparten una estructura común: el ordenador envía una código de petición seguido de un número de bloque, en consecuencia la FPGA devuelve una confirmación o una denegación en caso de estar ocupado. A continuación se recorre la memoria enviando o recibiendo byte a byte el contenido de un archivo FLAN hasta encontrar la marca de finalización. Además dispone de una petición de saludo para comprobar la conexión.

	\item {\itshape Controlador del códec de audio}: este controlador establece las señales de reloj y convierte una onda cuadrada en un valor estéreo de 20 bits apto para el códec de audio {\itshape AK4551} de la FPGA.
\end{enumerate}

\section{Desarrollo del proyecto}

\subsection{Bibliografía}
	Para la elaboración del generador de sonidos y el códec de audio ha sido de gran utilidad la documentación de la asignatura {\itshape Diseño Automático de Sistemas} de José Manuel Mendías, en \url{www.dacya.ucm.es/mendias/DAS/DAS.html}.

	\medskip La referencia principal para el diseño del sistema de comunicación entre el ordenador y la FPGA por el puerto serie es el libro \cite{PCHU} de Pong P. Chu. Adaptaciones de su transmisor y receptor de la UART se han utilizado en el proyecto. Del lado del ordenador se ha empleado la biblioteca de {\itshape Java} {\itshape RxTx} (una implementación de {\itshape Java Communications API}) disponible en \href{http://rxtx.qbang.org}{\nolinkurl{rxtx.qbang.org}}.

	\medskip Para el diseño del controlador VGA, se ha utilizado como base el fichero {\itshape vhdl} del campus virtual.

	\medskip El formato del lenguaje convertible a formato FLAN por el programa {\itshape MFlan} está inspirado y es compatible con la sintaxis del programa de composición tipográfica de partituras Lilypond (\href{http://lilypond.org}{\nolinkurl{lilypond.org}}). En el reproductor de archivos FLAN desde el ordenador se ha recurrido a la biblioteca multiplataforma {\itshape PortAudio} disponible en \url{www.portaudio.com}.

	\medskip El esquema del teclado del manual de usuario es una modificación un gráfico de Bruno Coudoin obtenido de \href{http://openclipart.org}{\nolinkurl{openclipart.org}}. Los esquemas de conexiones del mismo manual se han extraído del manual de la placa.

\subsection{Dificultades}
	Durante el desarrollo del proyecto hemos tenido que salvar dificultades varias, superando la mayoría de ellas con éxito. Podemos clasificarlas respecto al desarrollo de diversos componentes.

\begin{enumerate}
	\item {\itshape Códec de audio}: la escasa documentación y dificultad para encontrarla referente al códec de audio de la FPGA, así como la aparente aleatoriedad del comportamiento de la misma en lo referente al códec supuso un gran esfuerzo en el desarrollo así como una constante sensación de insatisfacción, el resultado final, es audible, pero sólo correctamente en algunas de las FPGA.

	\item {\itshape Teclado}: debido a la respuesta natural del teclado cuando se mantiene una tecla pulsada un periodo de tiempo (envía repeticiones de la misma), invertimos gran cantidad de tiempo intentando establecer una comunicación bidireccional con el teclado a través del protocolo PS/2 para reconfigurar el comportamiento del teclado y su respuesta cómo nos convenía. Finalmente después de muchos intentos y pruebas con proyectos ya existentes, todas ellas acabadas en fracaso, posiblemente por que la placa no esté preparada para transmitir por el puerto PS/2, optamos por corregir este comportamiento desde el lado de la FPGA ignorando las repeticiones de una tecla pulsada.

	\item {\itshape Comunicación puerto serie}: debido a la complejidad y delicadeza del sistema, encontramos en el desarrollo de los componentes para la comunicación bidireccional a través del puerto de serie entre el ordenador y la FPGA diversos problemas, referentes a sincronización de relojes y a la detección de fallos a través de pruebas en tiempo real, así como también con las librerías necesarias para el software dedicado del ordenador.
	Todas las dificultades referentes han sido resueltas satisfactoriamente, permitiendo almacenar y leer de memoria de la FPGA desde el ordenador a través del puerto de serie.
\end{enumerate}

Además de lo anteriormente mencionado, nos encontramos con varias dificultades, tales como inexplicables comportamientos de la placa, conflictos entre puertos y componentes usados de la FPGA.
Sin embargo a pesar de ello y gracias al tiempo invertido, hemos aumentado significativamente el conocimiento del lenguaje y del dispositivo, quedando mejor preparado para el desarrollo de futuros proyectos.

\subsection{Distribución del trabajo}

\subsection{Reivindicación}

\begin{figure}[ht]\centering
	\begin{tikzpicture}
		% Módulos interconectados
		\node (Arch) [modulo, minimum width=10cm] {archivero};
		\node (UC) [left=1em of Arch, modulo] {UC};
		\node (Mem) [right=1em of Arch, modulo] {(mem)};
		\node (Urx) [above left=2em and -8em of Arch, modulo] {uart\_tx};
		\node (Utx) [above right=2em and -8em of Arch, modulo] {uart\_rx};
		\node (Repr) [below left=2em and -8em of Arch, modulo] {reproductor};
		\node (Grab) [below right=2em and -8em of Arch, modulo] {grabador};

		% Conexiones
		
	\end{tikzpicture}

	\caption{Conexiones del archivero}
	\label{fig:archivero}
\end{figure}

\newpage
\phantomsection \addcontentsline{toc}{section}{Referencias}
\bibliography{toc}
\bibliographystyle{babalpha}
\end{document}
