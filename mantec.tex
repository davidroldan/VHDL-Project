\documentclass{article}

\usepackage[utf8x]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{palatino}
\usepackage[english, spanish, es-noquoting]{babel}
\usepackage{babelbib}
\usepackage{anysize}
\usepackage{tabu}
\usepackage{graphicx}
\usepackage{tikz}
\usepackage{url}
\usepackage[colorlinks]{hyperref}

% Configuración TikZ
\usetikzlibrary{positioning, calc}
\tikzset{modulo/.style={fill=yellow!80!black}, lineamus/.style={draw=green!80!black, thick}}

% Metadatos del PDF
\hypersetup{
	pdftitle={Teclado: manual técnico},
	pdfsubject={Tecnología y Organización de Computadores}
}

% Ajuste de rotura de palabras en salto de línea
\hyphenpenalty=5000
\tolerance=1000

\title{Teclado: manual técnico}
\author{Juan Andrés Claramunt Pérez, David Roldán Santos y Rubén Rafael Rubio Cuéllar}

\begin{document}

\maketitle

\tableofcontents

\section{Descripción del diseño}

\subsection{Ruta de datos}

\begin{figure}[ht]\centering
	\begin{tikzpicture}[node distance=5mm and 5mm]
		% Módulos de diseño del proyecto
		\node (UC) [modulo] {unidad central};
		\node (Gen) [above left= -1mm and 1cm of UC.north west, modulo] {gensonido};
		\node (Codec) [below left= 1mm and 1cm of UC.south west, modulo] {códec de audio};
		\node (Vga) [below=1 cm of UC, modulo] {vga};
		\node (VgaBarra) [below left=of Vga, modulo] {vga\_barra};
		\node (VgaTeclado) [below right=of Vga, modulo] {vga\_teclado};
		\node (Recon) [above=1cm of UC, modulo] {reconocedor}; 
		\node (Arch) [right=1.5 cm of UC, modulo] {archivero};
		\node (Mem) [above =of Arch, modulo] {(memoria)};
		\node (UART) [below=of Arch, modulo] {UART};
		\node (Grab) [above right= 0mm and 4mm of Arch.north east, modulo] {grabador};
		\node (Repr) [below right= 0mm and 4mm of Arch.south east, modulo] {reproductor};

		% Conexiones entre los módulos
		\draw [<-] (UC.180) -- (Gen);
		\draw [->, lineamus] (UC.north west) -- (Gen.5);
		\draw [<->, lineamus] (UC) -- (Arch);
		\draw (Arch) -- (Grab);
		\draw (Arch) -- (Repr);
		\draw (Arch) -- (Mem);
		\draw (Arch) -- (UART);
		\draw [->, lineamus] (UC) -- (Vga);
		\draw (Vga) -- (VgaBarra);
		\draw (Vga) -- (VgaTeclado);
		\draw [<->] (UC.south west) -- (Codec.0);
		\draw [->, lineamus]  (Recon.-40) -- (UC.40);
		\draw [->] (Recon.-140)-- (UC.140);
	\end{tikzpicture}
	\caption{Esquema de módulos e interconexión}
	\label{fig:esquema}
\end{figure}

	En la figura \ref{fig:esquema} las líneas gruesas verdes indican el paso de los ``parámetros musicales'': nota (3 bits), octava (3 bits) y sostenido (3 bits). Esta terna es el dato principal del diseño. Se origina en el {\itshape reconocedor} como resultado de la interacción del usuario o en el {\itshape archivero} por la reproducción de un archivo grabado. La unidad central selecciona la fuente activa en cada momento. Su destino es el  generador de sonidos ({\itshape gensonido}) que produce una onda cuadrada; también llega al controlador de pantalla y al archivero para la grabación.

\begin{figure}[ht]\centering
	\begin{tikzpicture}
		% Módulos interconectados
		\node (UC) [modulo, minimum width=10cm] {unidad central\strut};
		\node (Gen) [above=1cm of UC, modulo, minimum width=6cm] {gensonido\strut};
		\node (Tab) [above left=2em and -8em of Gen, modulo] {tablanotas};
		\node (TabS) [above right=2em and -8em of Gen, modulo] {tablanotassos};

		% Conexiones
		\draw [->] (UC.172) -- node[left]{\small reloj/reset} (Gen.-172); % reloj/reset
		\draw [->, lineamus] (UC.150) -- (Gen.-150);
		\draw [->] (Gen.-30) -- node[right]{\small onda} (UC.30);

		% Conexiones con las ROM
		\draw [->] (Gen.168) -- node[left]{\small nota} (Tab.-150);
		\draw [<-] (Gen.153) -- (Tab.-29);
		\draw [->] (Gen.30) -- (TabS.-162);
		\draw [<-] (Gen.9) -- node[right]{\small semiperiodo} (TabS.-19);
	\end{tikzpicture}

	\caption{Conexiones del generador de sonidos}
	\label{fig:gensonido}
\end{figure}

	\medskip La señal sonora generada por {\itshape gensonido} se dirige a un pin de salida de la FPGA para ser conectada a un zumbador o semejante. Sin embargo se conecta también al códec de audio que produce una señal analógica por el puerto de salida jack de 3,5mm del dispositivo.

	\medskip La memoria se gestiona en el módulo {\itshape archivero}. Se organiza en 20 bloques RAM de doble puerto y anchura 16 bits compartidos por el grabador, el reproductor y el transmisor. El reproductor lee desde el puerto A, el grabador escribe en el puerto B y el transmisor realiza sendas operaciones en los puertos cruzados. La reproducción y la grabación no pueden darse simultáneamente\footnote{Técnicamente sería posible en memorias diferentes con ligeras modificaciones.}, sin embargo la carga o descarga de datos por el transmisor pueden acontecer concurrentemente con aquellas si involucran a bloques distintos. El control de la compartición se maneja en el módulo.

\medskip \begin{figure}[ht]\centering
	\begin{tikzpicture}
		% Módulos interconectados
		\node (Arch) [modulo, minimum width=10cm] {archivero};
		\node (UC) [left=1em of Arch, modulo] {UC};
		\node (Mem) [right=1em of Arch, modulo] {(mem)};
		\node (Urx) [above left=2em and -12em of Arch, modulo, minimum width=4cm] {uart\_rx};
		\node (Utx) [above right=2em and -12em of Arch, modulo, minimum width=4cm] {uart\_tx};
		\node (Repr) [below left=2em and -12em of Arch, modulo, minimum width=4cm] {reproductor};
		\node (Grab) [below right=2em and -12em of Arch, modulo, minimum width=4cm] {grabador};

		% Conexiones
		\draw [<->, lineamus] (UC) -- (Arch);
		\draw [<->, thick] (Arch) -- (Mem);

		% Comunicación con el grabador y reproductor		
		\draw [->, lineamus] (Repr.north) -- ($(Arch.south west) !.221! (Arch.south east)$);
		\draw [<-, lineamus] (Grab.north) -- ($(Arch.south west) !.779! (Arch.south east)$);

		\draw [<-] ($(Repr.north west) !.1! (Repr.north east)$) -- node[left]{\small r/r} ($(Arch.south west) !.06! (Arch.south east)$); % reloj
		\draw [<-] ($(Repr.north west) !.2! (Repr.north east)$) -- ($(Arch.south west) !.101! (Arch.south east)$); % reloj div
		\draw [<-, thick] ($(Repr.north west) !.7! (Repr.north east)$) -- node[left]{\small mm} ($(Arch.south west) !.30! (Arch.south east)$); % datos memoria
		\draw [->, thick] ($(Repr.north west) !.75! (Repr.north east)$) -- ($(Arch.south west) !.32! (Arch.south east)$); % dirección
		\draw [<-] ($(Repr.north west) !.85! (Repr.north east)$) -- ($(Arch.south west) !.36! (Arch.south east)$); % activación
		\draw [->] ($(Repr.north west) !.9! (Repr.north east)$) -- node[right]{\small act} ($(Arch.south west) !.38! (Arch.south east)$); % fin

		\draw [<-] ($(Grab.north west) !.1! (Grab.north east)$) -- node[left]{\small r/r} ($(Arch.south west) !.618! (Arch.south east)$); % reloj
		\draw [<-] ($(Grab.north west) !.2! (Grab.north east)$) -- ($(Arch.south west) !.658! (Arch.south east)$); % reloj div
		\draw [->, thick] ($(Grab.north west) !.7! (Grab.north east)$) -- ($(Arch.south west) !.86! (Arch.south east)$); % datos memoria
		\draw [->, thick] ($(Grab.north west) !.75! (Grab.north east)$) -- ($(Arch.south west) !.88! (Arch.south east)$); % dirección
		\draw [->] ($(Grab.north west) !.8! (Grab.north east)$) -- ($(Arch.south west) !.90! (Arch.south east)$); % we
		\draw [<-] ($(Grab.north west) !.9! (Grab.north east)$) -- node[right]{\small act} ($(Arch.south west) !.94! (Arch.south east)$); % fin

		% Comunicación con el puerto serie
		\draw [->, thick] (Urx.south) -- ($(Arch.north west) !.221! (Arch.north east)$);
		\draw [<-, thick] (Utx.south) -- ($(Arch.north west) !.779! (Arch.north east)$);


		\draw [<-] ($(Urx.south west) !.1! (Urx.south east)$) -- node[left]{\small r/r} ($(Arch.north west) !.06! (Arch.north east)$); % reloj
		\draw [<-] ($(Urx.south west) !.2! (Urx.south east)$) -- ($(Arch.north west) !.101! (Arch.north east)$); % reloj div
		\draw [->] ($(Urx.south west) !.9! (Urx.south east)$) -- node[right]{\small fin} ($(Arch.north west) !.382! (Arch.north east)$); % done

		\draw [<-] ($(Utx.south west) !.1! (Utx.south east)$) -- node[left]{\small r/r} ($(Arch.north west) !.618! (Arch.north east)$); % reloj
		\draw [<-] ($(Utx.south west) !.2! (Utx.south east)$) -- ($(Arch.north west) !.658! (Arch.north east)$); % reloj div
		\draw [->] ($(Utx.south west) !.852! (Utx.south east)$) -- node[left]{\small done} ($(Arch.north west) !.92! (Arch.north east)$); % done
		\draw [<-] ($(Utx.south west) !.9! (Utx.south east)$) -- node[right]{\small start} ($(Arch.north west) !.94! (Arch.north east)$); % start
		
	\end{tikzpicture}

	\caption{Conexiones del archivero}
	\label{fig:archivero}
\end{figure}

\subsection{Controladores}

\begin{enumerate}
	\item {\itshape Controlador de teclado}: maneja la entrada por teclado. Las pulsaciones permiten tocar las notas musicales y activar ciertos comandos comandos de la máquina. El controlador recibe datos a través de la línea \verb|PS2DATA| con reloj \verb|PS2CLK| en serie desde el teclado. En base a ello establece valores acordes para los parámetros musicales o activa señales que desencadenarán acciones en otros componentes externos.

\begin{figure}[ht]\centering
	\begin{tikzpicture}
		% Módulos interconectados
		\node (UC) [modulo, minimum width=10cm] {unidad central};
		\node (Recon) [above=1cm of UC, modulo, minimum width=6cm] {reconocedor}; 

		% Conexiones
		\draw [->] (UC.174) -- node[left]{\small reloj/reset} (Recon.-174); % reloj/reset
		\draw [->, lineamus] (Recon.-170) -- (UC.170);
		\draw [->] (Recon.-7) -- (UC.7);		% botón octava+
		\draw [->] (Recon.-8) -- (UC.8);		% botón octava-
		\draw [->] (Recon.-10) -- (UC.10);	% botón parada
		\draw [->] (Recon.-12) -- (UC.12);	% botón reproducción
		\draw [->] (Recon.-15) -- node[left]{\small activadores} (UC.15); % botón grabación

		\draw [->, thick] (Recon.-6) -- node[right] {\small octava base} (UC.6);
	\end{tikzpicture}

	\caption{Conexiones del reconocedor}
	\label{fig:reconocedor}
\end{figure}

	\item {\itshape Controlador de pantalla}: se encarga de la salida por pantalla. El controlador lee las distintas señales que contienen la información sobre lo que se desea visualizar. A través de dos contadores que recorren la pantalla (\verb|hsync| y \verb|vsync|), se enviará la información al puerto VGA píxel a píxel.

	\item {\itshape Grabador/reproductor}: registra o reproduce una sucesión de notas musicales con su duración, siguiendo el formato FLAN ({\itshape Formato Lineal de Audible Notación}) que se compone de cuadros de 16 bits que representan notas musicales o comandos especiales (si el campo \verb|esp| está a 0). El campo nota toma valores \verb|000| para silencio, \verb|001| para la nota do y así sucesivamente hasta \verb|111| para la nota si. El campo \verb|octava| indica la octava numerada del 0 al 7 y \verb|sos| activa a 1 el sostenido. Se reservan 8 bits para la duración. El único comando especial reconocido es la marca de fin, totalmente nula. 

	\begin{figure}[ht] \centering
		\begin{tabular}{| l | l | l | l | l | l | l | l | l | l | l | l | l | l | l | l |}
			\hline esp & \multicolumn{3}{c|}{nota} & \multicolumn{3}{c|}{octava} & sos & \multicolumn{8}{c|}{duración} \\ \hline
			& & & & & & & & & & & & & & & \\ \hline
		\end{tabular}

		\label{fig:flan}
		\caption{Esquema del formato de representación FLAN}
	\end{figure}

	Tanto el grabador como el reproductor utilizan señales de reloj dividido a $2^{21}$ veces el reloj de la FPGA.

	\item {\itshape Controlador de comunicación serie}: maneja la comunicación bidireccional con el ordenador mediante el puerto serie RS232. El protocolo de comunicación permite enviar y recibir archivos de audio para ser cargados en la memoria.

	Las dos modalidades comparten una estructura común: el ordenador envía una código de petición seguido de un número de bloque, en consecuencia la FPGA devuelve una confirmación o una denegación en caso de estar ocupado. A continuación se recorre la memoria enviando o recibiendo byte a byte el contenido de un archivo FLAN hasta encontrar la marca de finalización. Además dispone de una petición de saludo para comprobar la conexión.

	El controlador está integrado en el módulo archivero ya que accede directamente a la memoria. El manejo a bajo nivel de la comunicación se lleva a cabo en la UART\footnote{{\itshape Universal Asynchronous Receiver and Transmitter}} que se compone de un emisor \verb|uart_tx| y un receptor \verb|uart_rx| que reciben o devuelven un byte en paralelo que transforman en serie por la línea correspondiente del RS232 a 9600 baudios. No hay bit de paridad ni se hace uso del resto de conexiones del protocolo. El método de conversión es el sobremuestreo en 16 partes.

	\item {\itshape Controlador del códec de audio}: este controlador establece las señales de reloj y convierte una onda cuadrada en un valor estéreo de 20 bits apto para el códec de audio {\itshape AK4551} de la FPGA.
\end{enumerate}

\subsection{Ocupación de la FPGA}

	\begin{center}\begin{tabular}{l r r}
		Número de {\itshape slice flip flops} & 276 & 1\% \\
		Número total de LUTS & 2.408 & 15\% \\
		Número de BELS & 2.974 & \\
		Número de bloques RAM (16) & 20 & 83\% \\
	\end{tabular}\end{center}

\section{Desarrollo del proyecto}

\subsection{Bibliografía}
	Para la elaboración del generador de sonidos y el códec de audio ha sido de gran utilidad la documentación de la asignatura {\itshape Diseño Automático de Sistemas} de José Manuel Mendías, en \url{www.dacya.ucm.es/mendias/DAS/DAS.html}. También se consultó la documentación del códec \cite{AK4565}. 

	\medskip La referencia principal para el diseño del sistema de comunicación entre el ordenador y la FPGA por el puerto serie es el libro \cite{PCHU} de Pong P. Chu. Adaptaciones de su transmisor y receptor de la UART se han utilizado en el proyecto. Del lado del ordenador se ha empleado la biblioteca de {\itshape Java} {\itshape RxTx} (una implementación de {\itshape Java Communications API}) disponible en \href{http://rxtx.qbang.org}{\nolinkurl{rxtx.qbang.org}}.

	\medskip Para el diseño del controlador VGA, se ha utilizado como base el fichero {\itshape vhdl} del campus virtual.

	\medskip Para la comprensión del protocolo de comunicación con el teclado se consultaron diferentes fuentes, entre ellas el capítulo 10 de \cite{RPDS}.

	\medskip El formato del lenguaje convertible a formato FLAN por el programa {\itshape MFlan} está inspirado y es compatible con la sintaxis del programa de composición tipográfica de partituras Lilypond (\href{http://lilypond.org}{\nolinkurl{lilypond.org}}). En el reproductor de archivos FLAN desde el ordenador se ha recurrido a la biblioteca multiplataforma {\itshape PortAudio} disponible en \url{www.portaudio.com}.

	\medskip El esquema del teclado del manual de usuario es una modificación un gráfico de Bruno Coudoin obtenido de \href{http://openclipart.org}{\nolinkurl{openclipart.org}}. Los esquemas de conexiones del mismo manual se han extraído del manual de la placa.

\subsection{Dificultades}
	Durante el desarrollo del proyecto hemos tenido que salvar dificultades varias, superando la mayoría de ellas con éxito. Podemos clasificarlas respecto al desarrollo de diversos componentes.

\begin{enumerate}
	\item {\itshape Códec de audio}: la escasa documentación y dificultad para encontrarla referente al códec de audio de la FPGA, así como la aparente aleatoriedad del comportamiento de la misma en lo referente al códec supuso un gran esfuerzo en el desarrollo así como una constante sensación de insatisfacción, el resultado final, es audible, pero sólo correctamente en algunas de las FPGA.

	\item {\itshape Teclado}: debido a la respuesta natural del teclado cuando se mantiene una tecla pulsada un periodo de tiempo (envía repeticiones de la misma), invertimos gran cantidad de tiempo intentando establecer una comunicación bidireccional con el teclado a través del protocolo PS/2 para reconfigurar el comportamiento del teclado y su respuesta cómo nos convenía. Finalmente después de muchos intentos y pruebas con proyectos ya existentes, todas ellas acabadas en fracaso, posiblemente por que la placa no esté preparada para transmitir por el puerto PS/2, optamos por corregir este comportamiento desde el lado de la FPGA ignorando las repeticiones de una tecla pulsada.

	\item {\itshape Comunicación puerto serie}: debido a la complejidad y delicadeza del sistema, encontramos en el desarrollo de los componentes para la comunicación bidireccional a través del puerto de serie entre el ordenador y la FPGA diversos problemas, referentes a sincronización de relojes y a la detección de fallos a través de pruebas en tiempo real, así como también con las librerías necesarias para el software dedicado del ordenador.
	Todas las dificultades referentes han sido resueltas satisfactoriamente, permitiendo almacenar y leer de memoria de la FPGA desde el ordenador a través del puerto de serie.
\end{enumerate}

Además de lo anteriormente mencionado, nos encontramos con varias dificultades, tales como inexplicables comportamientos de la placa, conflictos entre puertos y componentes usados de la FPGA.
Sin embargo a pesar de ello y gracias al tiempo invertido, hemos aumentado significativamente el conocimiento del lenguaje y del dispositivo, quedando mejor preparado para el desarrollo de futuros proyectos.

\subsection{Distribución del trabajo}
	En común hemos implementado el reconocedor del teclado y hemos revisado y mejorado el trabajo realizado por nuestros compañeros.

	\medskip Juan Andrés (véndete, cuanto más mejor)

	\medskip David se ha encargado de la interfaz gráfica, tanto de su diseño como de su implementación. Además, para incluir ciertas imágenes ha elaborado un conversor de archivos de imagen en formato .bmp a módulo VHDL.

	\medskip Rubén ha diseñado el formato FLAN, el protocolo de comunicación por el puerto serie y se ha encargado de la implementación y diseño del grabador. Para favorecer esta comunicación ha elaborado el manipulador de archivos FLAN {\itshape MFlan} y el programa {\itshape Eurotas} para la carga y descarga de canciones desde el ordenador. Ha colaborado en la implementación y prueba del módulo de manejo del códec de audio y del generador de sonidos.

\subsection{Reivindicación}
	Nuestro proyecto goza de gran originalidad debido a la utilización de múltiples componentes inexplorados en el ámbito de la asignatura. En concreto, hemos utilizado el códec de audio pese a la escasa documentación al respecto con la que contábamos. La comunicación por el puerto serie, aún siendo un clásico del diseño de computadores, no ha sido tratada más que en contadas ocasiones en los proyectos desarrollados en esta asignatura o en asignaturas relacionadas en esta facultad, a la vista de las diversas relaciones de proyectos accesibles.

	Adicionalmente, contamos con un amplio número de programas que hemos desarrollado tanto como ayuda en la elaboración del proyecto como de utilidad para el usuario final.

	A pesar de la complejidad de nuestro proyecto, hemos conseguido optimizar el número de elementos hardware utilizados, lo que permite una rápida compilación, favoreciendo así la prueba de cambios. Además esto facilita hipotéticas ampliaciones de su funcionalidad.

	\medskip Por todo ello y teniendo en cuenta además la completitud y la armonía de los diferentes partes del diseño, consideramos que nuestro proyecto no sólo ha alcanzado las expectativas iniciales, sino que ha superado con éxito los nuevos propósitos que han surgido durante su realización.

\newpage
\phantomsection \addcontentsline{toc}{section}{Referencias}
\bibliography{toc}
\bibliographystyle{babalpha}
\end{document}
