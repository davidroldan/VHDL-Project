\documentclass{article}

\usepackage[utf8x]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{palatino}
\usepackage[spanish]{babel}
\usepackage{anysize}
\usepackage{tabu}
\usepackage{graphicx}

\usepackage{tikz}
\usetikzlibrary{trees}

\usepackage[colorlinks]{hyperref}

\PrerenderUnicode{í}
\PrerenderUnicode{ó}

\pdfinfo{
	/Title (Teclado: manual de uso)
	/Subject (Tecnología y Organización de Computadores)
}

\hyphenpenalty=5000
\tolerance=1000

\title{Teclado: manual de uso}
\author{Juan Andrés Claramunt Pérez, David Roldán Santos y Rubén Rafael Rubio Cuéllar}

\begin{document}

\maketitle

\section{Ficheros y dependencias}

% Separación de las filas de la tabla
\let\sep\hline

% TODO: faltan archivos ¿sobran?

\begin{tabu}{| >{\itshape}X[2, l] | X[7, l] |}
	\multicolumn{2}{c}{\bfseries Archivos principales} \\ \sep
	archivero.vhd & Archivero (reproductor, grabador, memoria y comunicación serie) \\ \sep
	audiocod.vhd & Controlador del códec de audio \\ \sep
	display.vhd & Controlador del display de 7 segmentos \\ \sep
	estabilizador.vhd & Estabilizador de señal de 1 bit \\ \sep
	gensonido.vhd & Generador de ondas sonoras binarias \\ \sep
	grabador.vhd & Grabador \\ \sep
	pines.ucf & Pines \\ \sep
	reconocedor.vhd & Reconocedor de teclado \\ \sep
	reproductor.vhd & Reproductor \\ \sep
	segments.vhd & Conversor de binario a display de 7 segmentos \\ \sep
	tablanotas.vhd & Tabla de semiperiodos de nota \\ \sep
	tablanotassos.vhd & Tabla de semiperiodos de nota (con sostenido) \\ \sep
	teclado.vhd & Entidad principal \\ \sep
	tipos.vhd & Paquete de tipos y definiciones comunes \\ \sep
	uart\_rx.vhd & Transistor de la UART (comunicación serie) \\ \sep
	uart\_tx.vhd & Receptor de la UART (comunicación serie) \\ \sep
	vga.vhd & Controlador de pantalla \\ \sep
	vga\_barras.vhd & Componente de barras (pantalla) \\ \sep
	vga\_recButton.vhd & Señal de grabación (pantalla) \\ \sep
	vga\_teclado.vhd & Componente teclado (pantalla) \\ \sep

	% ¿Incluimos estos archivos?
	\multicolumn{2}{c}{} \\
	\multicolumn{2}{c}{{\bfseries Simulaciones} en {\itshape pruebas}} \\ \sep
	sim\_archivero.vhd & Simulación del archivero \\ \sep
	sim\_codec.vhd & Simulación del códec \\ \sep
	sim\_grab.vhd & Simulación del grabador \\ \sep
	sim\_repr.vhd & Simulación del reproductor \\ \sep

	\multicolumn{2}{c}{} \\
	\multicolumn{2}{c}{{\bfseries Conversor BMP a VHD} en {\itshape conversorBMPtoVHD}} \\ \sep
	converter.cpp & Archivo principal \\ \sep
\end{tabu}

\vspace*{1cm}

\begin{figure}[ht] \centering
\begin{tikzpicture}[level 1/.style={sibling distance=20mm}]

	\node {archivero} [style=edge from parent fork down]
		child { node {reproductor} }
		child { node {grabador} }
		child { node {uart\_rx} }
		child { node {uart\_tx} }
	;
\end{tikzpicture}
\caption{Árbol de dependencias de los archivos de la descripción {\itshape hardware} (archivero)}
\end{figure}

\begin{figure}[ht] \centering
\begin{tikzpicture}[level 1/.style={sibling distance=20mm}]

	\node {teclado} [style=edge from parent fork down]
		child {
			node {gensonido}
			child { node {tablanotas} }
			child { node {tablanotassos} }
		}
		child { node {reconocedor} }
		child {
			node {archivero*}
		}
		child {
			node {vga}
			child { node {vga\_barras} }
			child { node {vga\_\ldots} }
			child { node {vga\_teclado} }
		}
		child { node {audiocod} }
		child {
			node {display}
			child { node {segments} }
		}
		child { node {pines.ucf} }
	;
\end{tikzpicture}
\caption{Árbol de dependencias de los archivos de la descripción {\itshape hardware}}
\end{figure}

\begin{tabu}{| >{\itshape}X[3, l] | X[5, l] |}
	\multicolumn{2}{c}{{\bfseries Manipulador de archivos FLAN} en {\itshape mflan}} \\ \sep
	Léeme.txt & Instrucciones de compilación \\ \sep
	Makefile & Archivo de construcción (GNU Makefile) \\ \sep
	Makefile.mak & Archivo de construcción (Microsoft NMake) \\ \sep
	lylector.cpp & Lector de archivos de partitura \\ \sep
	lylector.h & \\ \sep
	main.cpp & Archivo principal \\ \sep
	mflan.cpp & Clase principal \\ \sep
	mflan.h & \\ \sep
	nota.h & Clase abstracta Nota. \\ \sep
	notaFPGA.cpp & Nota del formato FLAN \\ \sep
	notaFPGA.h & \\ \sep
	ondaseno.cpp & Onda senoidal (con PortAudio) \\ \sep
	ondaseno.h & \\ \sep
	operacion.h & Clase abstracta Operación \\ \sep
	ops/op\_convertir.cpp & Operación de conversión \\ \sep
	ops/op\_convertir.h & \\ \sep
	ops/op\_escalar.cpp & Operación de cambio de escala \\ \sep
	ops/op\_escalar.h & \\ \sep
	ops/op\_leer.cpp & Operación de lectura y comprobación \\ \sep
	ops/op\_leer.h & \\ \sep
	ops/op\_reproducir.cpp & Operación de reproducción \\ \sep
	ops/op\_reproducir.h & \\ \sep
	tamborilero.txt & Archivo de partitura de ejemplo \\ \sep

	\multicolumn{2}{c}{} \\
	\multicolumn{2}{c}{{\bfseries Cargador/descargador de archivos} en {\itshape eurotas}} \\ \sep
	Léeme.txt & Intrucciones de compilación y uso \\ \sep
	toc/Main.java & Clase principal \\ \sep
	toc/OyenteTarea.java & Interfaz de oyente de tarea \\ \sep
	toc/comm/Cargador.java & Cargador de archivos en la FPGA \\ \sep
	toc/comm/Comunicador.java & Clase abstracta: comunicador con la FPGA \\ \sep
	toc/comm/Descargador.java & Descargador de archivos desde la FPGA \\ \sep
	toc/comm/ErrorComunicacion.java & Excepción de error en la comunicación \\ \sep
	toc/comm/OyenteSerieDebug.java & Oyente de eventos de la comunicación \\ \sep
	toc/comm/Saludador.java & Saludador de la FPGA \\ \sep
	toc/comm/package-info.java & Información del paquete {\itshape toc.comm} \\ \sep
	toc/gui/MonitorProgreso.java & Diálogo monitor del progreso \\ \sep
	toc/gui/PanelArchivo.java & Panel de selección de archivos \\ \sep
	toc/gui/PanelArchivoListener.java & Oyente del selector de archivos s\\ \sep
	toc/gui/VentanaPpal.java & Ventana principal \\ \sep
	toc/gui/package-info.java & Información del paquete {\itshape toc.gui} \\ \sep
	toc/package-info.java & Información del paquete {\itshape toc} \\ \sep
\end{tabu}

\section{Pines}

\begin{tabu}{|>{\bfseries}X[1, l] | >{\tt}X[2, l] | >{\itshape}X[1, l] |X[10, l] |}
	\sep T9 & reloj & in & Señal de reloj de la FPGA \\ \sep
	J4 & reset & in & Interruptor de reinicio \\ \sep
	D15 & onda & out & Señal de onda \\ \sep

	\multicolumn{4}{c}{\bfseries Teclado PS/2} \\ \sep	
	B16 & PS2CLK & in & Reloj del teclado PS/2 \\ \sep
	E13 & PS2DATA & in & Bit de datos del teclado PS/2 \\ \sep
	
	\multicolumn{4}{c}{\bfseries Códec de audio} \\ \sep
	P11 & au\_mclk & out & Reloj principal \\ \sep
	R12 & au\_lrck & out & Selector de canal \\ \sep
	T12 & au\_bclk & out & Reloj de la entrada en serie del códec \\ \sep
	M10 & au\_sdti & out & Entrada de datos \\ \sep

	\multicolumn{4}{c}{\bfseries Pantalla} \\ \sep
	B7 & hsyncb & in & Bit de sincronía horizontal \\ \sep
	D8 & vsyncb & inout? & Bit se sincronía vertical \\ \sep

	\multicolumn{4}{c}{\bfseries LED indicadores} \\ \sep
	L5 & led\_repr & out & LED que indica si se está reproduciendo \\ \sep
	N2 & led\_grab & out & LED que indica si se está grabando \\ \sep
	M3 & led\_trans & out & Indica si se están transmitiendo datos por el puerto serie \\ \sep

	\multicolumn{4}{c}{\bfseries Puerto serie} \\ \sep
	G5 & rs232\_rd & in & Entrada de datos \\ \sep
	J2 & rs232\_td & out & Salida de datos \\ \sep
\end{tabu}

	\bigskip Otros conjuntos de pines son:

\medskip \begin{tabu}{| X[5, l] | >{\tt}X[1,l] | X[1, l] | X[5, l] |}
	\sep
	Señal RGB para la pantalla & rgb & 0..8 & (D5, E7, C9, C3, A5, A8, B1, D6, C8) \\ \sep
	Display de 7 segmentos izquierdo & dspiz & 0..6 & (H14, M4, P1, N3, M15, H13, G16) \\ \sep
	Display de 7 segmentos derecho & dspdr & 0..6 & (E2, E1, F3, F2, G4, G3, G1) \\ \sep
\end{tabu} 

\section{Inicialización}

	Antes de comenzar, es necesario conectar un teclado al puerto PS2 de la FPGA. Si se dispone de un zumbador o semejante (como por ejemplo el de la placa de pruebas del laboratorio) se puede utilizar como altavoz conectándolo al pin {\color{blue} D15}. Si por el contrario, se pretende escuchar utilizando auriculares u otros dispositivos que cuenten con conector compatible se podrán conectar estos al puerto a tal efecto de la FPGA, aunque su funcionamiento puede depender de la FPGA utilizada. Para ello la disposición de los {\itshape jumper} JP2-JP5 ha de ser la que indica la figura \ref{fig:jump}.

\begin{figure}[ht] \centering
	\includegraphics[scale=.3]{poscodec.png}

	\caption{Posición de los {\itshape jumper} para eschuchar con auriculares}
	\label{fig:jump}
\end{figure}


	\medskip Para poder contemplar los contenidos visuales será necesario conectar una pantalla a la FPGA mediante el conector VGA.

	\medskip Para permitir la transferencia de archivos de audio entre el ordenador y la FPGA, se ha de conectar el cable serie al puerto RS232 de la placa. La configuración de los {\itshape jumper} del puerto serie ha de ser idéntica a la de la figura \ref{fig:rs232} (conexión null módem).

% ¿La conexión es ésta?
\begin{figure}[ht] \centering
	\includegraphics[scale=.25]{posserie.png}

	\caption{Posición de los {\itshape jumper} para la transferencia de archivos}
	\label{fig:rs232}
\end{figure}

\section{Funcionamiento}

	El teclado funciona en diferentes modos:

	\begin{enumerate}
		\item {\itshape Modo teclado}: por defecto el sistema funciona como un piano cuyo teclado es el teclado conectado a la FPGA. Las diferentes notas (dos octavas y media simultáneamente) se distribuyen de acuerdo al esquema de la figura \ref{fig:teclado}. Se puede variar la octava con las flechas verticales del teclado numérico. El número de octava se muestra en el display de 7 segmentos al pulsar un nota natural. Al pulsar las teclas se produce sonido y simultáneamente se muestran diversas animaciones en la pantalla.

\begin{figure}[ht] \centering
	\includegraphics[scale=1.8]{keyboard.pdf}

	\caption{Disposición del teclado}
	\label{fig:teclado}
\end{figure}

	\item {\itshape Modo reproducción y grabación}: la fila central del teclado numérico permite activar o desactivar la reproducción o la grabación de pistas almacenadas en los bloques de memoria de la FPGA. Se cuenta con 20 bloques activos que permiten almacenar cada uno hasta 8 minutos de grabación (en silencio) con una sensibilidad de 10,49 ms. Para cambiar de bloque de memoria se dispone de las teclas {\itshape AvPág} y {\itshape RePág} del teclado numérico. El display de 7 segmentos mostrará en reposo el bloque de memoria seleccionado.

		Durante la reproducción sonará el contenido del bloque de memoria seleccionado mostrándose en la pantalla como si se tocase a mano. Las pulsaciones en la parte sonora del teclado serán ignoradas.

		En la grabación se registrará aquello que se esté tocando con el teclado.

	\item {\itshape Modo transmisión}: en todo momento se podrán transferir archivos de audio desde y hasta los bloques de memoria de la FPGA, siempre que el bloque requerido no esté ocupado por una grabación o reproducción.

		Se incluye un repertorio de canciones de muestra en un formato humanamente legible semejante al del programa de composición tipográfica de partituras \href{http://lilypond.org/}{Lilypond}. El programa {\itshape MFlan} convierte archivos en este formato al formato {\itshape FLAN}. Además permite leer y reproducir las grabaciones obtenidas desde la FPGA.

		Para la transferencia de canciones entre la FPGA y el ordenador se dispone del programa {\itshape Eurotas}. Su manejo no requiere mayor explicación.

\begin{figure}[ht] \centering
	\includegraphics[scale=.55]{eurotas.png}

	\caption{La interfaz del transmisor {\itshape Eurotas}}
	\label{fig:eurotas}
\end{figure}
	\end{enumerate}
\section{¿Qué espero ver?}

\end{document}
